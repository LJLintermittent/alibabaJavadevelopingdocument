# 《阿里巴巴Java开发手册--部分重点摘录与分析》

## 第六章 工程结构

### 应用分层

* 【推荐】根据业务架构实践，结合业界分层规范与流行技术框架分析，推荐分层结构如下图所示，默认上层依赖于下层，箭头关系表示可以直接依赖，如：开放API层可以依赖于请求处理层(web层)，也可以直接依赖于业务逻辑层(service层)

![image](https://cdn.jsdelivr.net/gh/chen-xing/figure_bed_02/cdn/20210712144015966.png)

①开放API层，可直接封装service接口暴露成HSF接口，通过web封装成HTTP接口，网关控制层等

②终端显示层：各个端的模板渲染并执行显示层，当前主要是velocity渲染，JS渲染，JSP渲染和移动端展示层等

③请求处理层(web层)：主要转发访问控制，校验各类基本参数，或者简单处理不复用的业务等

④业务逻辑层(service层)：相对具体的业务逻辑服务层

⑤通用逻辑层(Manager层)：有如下特征：
1.对第三方平台封装的层，预处理返回结果及转化异常信息，适配上层接口

2.对service层通用能力的下沉，如缓存方案，中间件通用处理

3.与Dao层交互，对Dao的业务通用能力的封装

⑥数据持久层(Dao层)：与底层MySQL，Oracle，HBase和OB进行数据交互

⑦第三方服务：包括其他部门的RPC服务接口，基础平台，其他公司的HTTP接口，如淘宝开放平台，支付宝付款服务，高德地图服务等

⑧外部数据接口：外部数据存储服务提供的接口，多见于数据迁移场景中

* 【参考】 （分层异常处理规约）在DAO层，产生的异常类型有很多，无法用细粒度的异常进行catch，使用catch（Exception e）方式，并throw new DAOException(e)，不需要打印日志，因为日志在manager/service层，一定需要捕获并写到日志文件中去，如果同台服务器再写日志，则会降低性能和浪费存储，当service层出现异常时，必须将出错日志记录到磁盘，尽可能带上参数信息，相当于保护案发现场。如果manager层与service层同机部署，则日志方式与DAO层处理一致，如果是单独部署，则采用与service层一致的处理方式。web层绝不应该继续向上抛出异常，因为已经处于顶层，如果意识到该异常将导致页面无法正常渲染，应该直接跳转到友好错误页面，加上用户容易理解的错误提示信息。开放接口层需要将异常处理成errorCode和errorMessage的方式返回

* 【参考】分层领域模型规约

  ~~~wiki
  1) DO：与数据库表结构一一对应，通过DAO层向上传输数据源对象
  2) DTO：数据传输对象，service层或manager层向外传输的对象
  3) BO：业务对象，可以由service层输出的封装业务逻辑的对象
  4) Query：数据查询对象，各层接收上层的查询请求，注意【强制】如果超过2个参数的查询封装，则禁止使用Map类传输
  5) VO：显示层对象，通常是web层向模板渲染引擎层传输的对象
  ~~~

### 服务器

* 【推荐】高并发服务器建议调小TCP协议的time_wait超时时间

  ~~~wiki
  说明：操作系统默认240s后，才会关闭处于time_wait状态的连接，在高并发访问的场景下，服务器端会因为处于time_wait的连接数过多，而无法建立新的连接，所以需要在服务器上调小此等待值
  正例：在linux服务器上可通过变更/etc/sysctl.conf文件修改该默认值(s)
  net.ipv4.tcp_fin_timeout = 30
  ~~~

* 【推荐】调大服务器所支持的最大文件句柄数，即fd(file descriptor)

  ~~~wiki
  说明：主流操作系统的设计是将TCP/UDP连接采用与文件一样的方式管理，即一个连接对应一个fd。主流的linux服务器默认支持最大的fd数量为1024，当并发连接很大的时候，很容易因为fd不足而出现“open too many files”错误，导致新的连接无法建立。建议将linux服务器所支持的最大文件句柄数调高数倍(与服务器的内存数量相关)
  ~~~

* 【推荐】给JVM环境参数设置-xx：+HeapDumpOnOutOfMemoryError参数，让JVM碰到OOM场景时输出dump信息

  ~~~wiki
  说明：oom的发生是由概率的，甚至相隔数个月才出现一例，出错时的堆信息对解决问题非常有帮助
  ~~~

* 【推荐】在线上生产环境中，将JVM的Xms和Xmx的内存容量设置为同样大小，避免在GC后调整堆大小带来的压力

## 阿里巴巴Java开发手册 第六章重点摘录完结



